<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Manajemen Air Bersih</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{font-family:Arial;background:#0f172a;color:white;margin:0}
header{background:#020617;padding:14px;text-align:center;font-size:20px;font-weight:bold}
nav{background:#020617;padding:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
nav button{background:#0ea5e9;border:none;padding:8px 12px;border-radius:6px;color:black;cursor:pointer}
section{display:none;padding:20px}
.active{display:block}
input,select{padding:7px;border-radius:6px;border:none;margin:4px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #334155;padding:6px;text-align:center}
.box{background:#020617;padding:12px;border-radius:10px;max-width:1100px;margin:auto}
.info{margin-top:8px;color:#38bdf8}
</style>
</head>
<body>

<header>APLIKASI MANAJEMEN AIR BERSIH</header>

<div id="loginBox" class="box" style="max-width:320px;margin:40px auto">
<h3>LOGIN</h3>
<input id="u" placeholder="Username"><br>
<input id="p" type="password" placeholder="Password"><br>
<button onclick="login()">LOGIN</button>
<div id="lmsg"></div>
</div>

<div id="app" style="display:none">

<nav id="menu"></nav>

<section id="petugas" class="active box">
<h3>INPUT METER (PETUGAS)</h3>
<input id="i_unit" placeholder="GM-A1.01 / TK-102">
<input id="i_lalu" type="number" placeholder="Meter lalu">
<input id="i_ini" type="number" placeholder="Meter ini">
<button onclick="simpanInput()">Simpan</button>
<div id="i_info"></div>
</section>

<section id="admin" class="box">
<h3>ADMIN PANEL</h3>
<button onclick="show('rekap')">Rekap</button>
<button onclick="show('bulan')">Rekap Bulanan</button>
<button onclick="show('set')">Tutup Bulan</button>
<button onclick="logout()">Logout</button>
</section>

<section id="rekap" class="box">
<h3>REKAP</h3>
<button onclick="exportExcel()">Export Excel</button>
<button onclick="window.print()">Export PDF</button>
<table><thead><tr><th>Tanggal</th><th>Unit</th><th>Total</th></tr></thead><tbody id="tbRekap"></tbody></table>
</section>

<section id="bulan" class="box">
<h3>REKAP BULANAN</h3>
<select id="bln" onchange="rekapBulan()"></select>
<table><thead><tr><th>Unit</th><th>Total m3</th><th>Total Tagihan</th></tr></thead><tbody id="tbBulan"></tbody></table>
</section>

<section id="set" class="box">
<h3>TUTUP BULAN</h3>
<input id="lockm" type="month">
<button onclick="lock()">TUTUP</button>
<div id="sinfo"></div>
</section>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwEuwSBlFK04lrIlPM--0DCcijrCfZBuqDzBWp3qSrBEZCqBUfQVz4CWGHWF91iaEw/exec";
let TOKEN="", ROLE="";

// ===== LOGIN =====
async function login(){
 let r=await fetch(API,{method:"POST",body:JSON.stringify({
  action:"login",username:u.value,password:p.value
 })}).then(r=>r.json());

 if(!r.status){lmsg.innerHTML="Login gagal";return;}

 TOKEN=r.token; ROLE=r.role;
 sessionStorage.setItem("token",TOKEN);
 sessionStorage.setItem("role",ROLE);
 init();
}

function logout(){sessionStorage.clear();location.reload();}
function init(){
 TOKEN=sessionStorage.getItem("token");
 ROLE=sessionStorage.getItem("role");
 loginBox.style.display="none";
 app.style.display="block";

 if(ROLE=="petugas"){
   menu.innerHTML=`<button onclick="show('petugas')">Input Meter</button><button onclick="logout()">Logout</button>`;
   show("petugas");
 }

 if(ROLE=="admin"){
   menu.innerHTML=`<button onclick="show('admin')">Admin</button><button onclick="show('rekap')">Rekap</button><button onclick="show('bulan')">Bulanan</button><button onclick="show('set')">Tutup Bulan</button><button onclick="logout()">Logout</button>`;
   loadRekap(); loadBulanList();
   show("admin");
 }
}

if(sessionStorage.getItem("token")) init();

// ===== CORE =====
function show(id){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

async function apiGet(m){
 return fetch(API+"?mode="+m+"&token="+TOKEN).then(r=>r.json());
}
async function apiPost(o){
 o.token=TOKEN;
 return fetch(API,{method:"POST",body:JSON.stringify(o)}).then(r=>r.json());
}

// ===== PETUGAS =====
async function simpanInput(){
 let r=await apiPost({mode:"input",values:[new Date(),i_unit.value,i_lalu.value,i_ini.value,"",""]});
 i_info.innerHTML = r.status ? "✔ Tersimpan" : "✖ Gagal";
}

// ===== ADMIN =====
async function loadRekap(){
 let d=await apiGet("rekap");
 tbRekap.innerHTML=d.map(x=>`<tr><td>${x["TANGGAL BAYAR"]||x["TANGGAL"]||""}</td><td>${x["NO UNIT"]}</td><td>${x["TOTAL"]||x["TOTAL TAGIHAN"]}</td></tr>`).join("");
}

async function loadBulanList(){
 let d=await apiGet("hitung");
 let m=[...new Set(d.map(x=>new Date(x["TANGGAL"]).toISOString().slice(0,7)))];
 bln.innerHTML=m.map(x=>`<option>${x}</option>`).join("");
}

async function rekapBulan(){
 let d=await apiGet("hitung");
 let m=bln.value;
 let f=d.filter(x=>new Date(x["TANGGAL"]).toISOString().slice(0,7)==m);
 let map={};
 f.forEach(x=>{
  if(!map[x["NO UNIT"]]) map[x["NO UNIT"]]={pakai:0,total:0};
  map[x["NO UNIT"]].pakai+=Number(x["PEMAKAIAN M3"]);
  map[x["NO UNIT"]].total+=Number(x["TOTAL"]);
 });
 tbBulan.innerHTML=Object.keys(map).map(k=>
 `<tr><td>${k}</td><td>${map[k].pakai}</td><td>Rp ${map[k].total.toLocaleString("id-ID")}</td></tr>`
 ).join("");
}

// ===== EXPORT =====
function exportExcel(){
 let wb=XLSX.utils.book_new();
 let ws=XLSX.utils.table_to_sheet(tbRekap);
 XLSX.utils.book_append_sheet(wb,ws,"REKAP");
 XLSX.writeFile(wb,"rekap_air.xlsx");
}

// ===== LOCK =====
async function lock(){
 let r=await apiPost({mode:"lock",month:lockm.value});
 sinfo.innerHTML = r.status ? "✔ Bulan dikunci" : "✖ Gagal";
}
</script>
</body>
</html>
