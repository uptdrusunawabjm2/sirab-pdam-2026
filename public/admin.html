<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin PDAM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen flex">

<!-- SIDEBAR -->
<div id="sidebar"
class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300">

<div class="p-4 border-b border-slate-800">
<div class="text-xl font-bold">Admin Panel</div>
<div class="text-xs text-slate-400">Sistem PDAM</div>
</div>

<div class="flex-1 p-4 space-y-2 text-sm">
<a href="#" class="block p-2 rounded bg-slate-800">ðŸ“Š Dashboard</a>
</div>

<div class="p-4 border-t border-slate-800">
<button onclick="logout()"
class="w-full bg-red-600/20 text-red-400 border border-red-600 px-3 py-2 rounded hover:bg-red-600 hover:text-white transition">
ðŸšª Logout
</button>
</div>

</div>

<!-- CONTENT -->
<div class="flex-1 flex flex-col">

<!-- TOPBAR -->
<div class="bg-slate-900 border-b border-slate-800 p-3 flex items-center gap-3">
<button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-1 rounded">â˜°</button>
<div class="font-semibold flex-1 text-center">Dashboard Admin PDAM</div>
</div>

<div class="p-4 space-y-4">

<!-- CARD REKAP -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-3">

  <div class="bg-slate-900 border border-slate-800 rounded-lg px-4 py-2">
    <div class="text-slate-400 text-xs">Total Input Data</div>
    <div id="rTotal" class="text-lg font-bold">0</div>
  </div>

  <div class="bg-blue-600/20 border border-blue-600 rounded-lg px-4 py-2">
    <div class="text-blue-300 text-xs">Pemakaian Air Bulan Ini</div>
    <div id="rBulan" class="text-lg font-bold text-blue-400">0</div>
  </div>

  <div class="bg-emerald-600/20 border border-emerald-600 rounded-lg px-4 py-2">
    <div class="text-emerald-300 text-xs">Total Pemakaian Air</div>
    <div id="totalPakai" class="text-lg font-bold text-emerald-400">0</div>
  </div>

</div>

<!-- FILTER -->
<div class="flex gap-2 items-center">

  <input id="search"
  oninput="applyFilter()"
  placeholder="ðŸ” Cari unit..."
  class="flex-1 p-2 rounded bg-slate-800 border border-slate-700">

  <input type="date"
  id="filterTanggal"
  onchange="applyFilter()"
  class="p-2 rounded bg-slate-800 border border-slate-700">

  <button onclick="resetFilter()"
  class="px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded font-semibold">
  âŸ² Reset
  </button>

  <button onclick="exportExcel()"
  class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold">
  â¬‡ Export Excel
  </button>

</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[70vh]">
<table class="w-full text-sm">
<thead class="bg-slate-800 sticky top-0">
<tr>
<th class="p-2 text-left">Tanggal</th>
<th class="p-2 text-left">Unit</th>
<th class="p-2 text-left">Meter Lalu</th>
<th class="p-2 text-left">Meter Ini</th>
<th class="p-2 text-left">Pemakaian</th>
<th class="p-2 text-left">Foto</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>
<!-- PAGER -->
<div class="flex gap-2 mt-3 items-center">
  <button onclick="prevPage()" class="px-3 py-1 bg-slate-700 rounded">Prev</button>
  <span id="pageInfo">Page 1</span>
  <button onclick="nextPage()" class="px-3 py-1 bg-slate-700 rounded">Next</button>
</div>
</div>
</div>

<script>

const API="https://script.google.com/macros/s/AKfycbwy8MDN7v6zH-5WbBIN3YVm0q0AchlT8y7zP7_H0nAkH3WhkeogXfzHoB_IZsHF3NSGug/exec";
const TOKEN=sessionStorage.token;
if(!TOKEN) location.href="index.html";

let DATA=[];
let VIEW=[];
let PAGE=1;
const PAGE_SIZE=50;

async function load(){
  const r=await fetch(API+"?mode=input&token="+TOKEN);
  const json=await r.json();

  DATA=preprocessData(json.data || json || []);
  VIEW=DATA;

  hitungRekap();
  renderTable();
}

function hitungRekap(){
  document.getElementById("rTotal").textContent=DATA.length;

  const bulan=new Date().getMonth();
  const tahun=new Date().getFullYear();

let bulanIni=0;

DATA.forEach(d=>{
  const t=new Date(d["TANGGAL"]);
  const pakai = Number(d._pakai);
  if(
    t.getMonth()===bulan &&
    t.getFullYear()===tahun &&
    !isNaN(pakai) &&
    pakai>0
  ){
    bulanIni += pakai;
  }
});

document.getElementById("rBulan").textContent=bulanIni;
}

function preprocessData(raw){

  // Kelompokkan data per UNIT
  const byUnit = {};
  raw.forEach(r=>{
    const u=r["NO UNIT"];
    if(!byUnit[u]) byUnit[u]=[];
    byUnit[u].push(r);
  });

  let total=0;

  // Hitung pemakaian PER UNIT berdasarkan histori
  Object.values(byUnit).forEach(list=>{

    // urutkan lama â†’ baru untuk hitung
    list.sort((a,b)=> new Date(a["TANGGAL"]) - new Date(b["TANGGAL"]));

    let last=null;

    list.forEach(r=>{
      const meter=Number(r["ANGKA METER"])||0;

      if(last!==null){
        const pakai = meter - last;
        r._meterLalu = last;
        r._pakai = pakai>=0 ? pakai : "-";
        if(pakai>=0) total += pakai;
      }else{
        r._meterLalu = "-";
        r._pakai = "-";
      }

      last = meter;
    });
  });

  // TOTAL PEMAKAIAN
  document.getElementById("totalPakai").textContent = total;

  // JANGAN UBAH URUTAN TABEL (biarkan terbaru di atas seperti sekarang)
  return raw.sort((a,b)=> new Date(b["TANGGAL"]) - new Date(a["TANGGAL"]));
}

function renderTable(){

  const tbody=document.getElementById("dataTable");
  if(!tbody) return;
  tbody.innerHTML="";

  const start=(PAGE-1)*PAGE_SIZE;
  const end=start+PAGE_SIZE;
  const slice=VIEW.slice(start,end);

  const frag=document.createDocumentFragment();

  for(const r of slice){

    const tr=document.createElement("tr");
    tr.className="border-b border-slate-700 hover:bg-slate-800";

    tr.innerHTML=`
      <td class="p-2">${formatTanggal(r["TANGGAL"])}</td>
      <td class="p-2 font-semibold">${r["NO UNIT"]}</td>
      <td class="p-2">${r._meterLalu}</td>
      <td class="p-2">${isNaN(Number(r["ANGKA METER"])) ? "-" : Number(r["ANGKA METER"])}</td>
      <td class="p-2 ${Number(r._pakai)>25 || Number(r._pakai)<1 ? 'text-yellow-400 font-bold' : 'font-semibold'}">
        ${r._pakai==="-"?"-":r._pakai}
        </td>
      <td class="p-2">
        ${r["FOTO_URL"]?`<a href="${r["FOTO_URL"]}" target="_blank" class="text-cyan-400">Lihat</a>`:"-"}
      </td>
    `;

    frag.appendChild(tr);
  }

  tbody.appendChild(frag);
  renderPager();
}

function renderPager(){
  const totalPage=Math.ceil(VIEW.length/PAGE_SIZE)||1;
  document.getElementById("pageInfo").textContent=`Page ${PAGE} / ${totalPage}`;
}

function nextPage(){
  const totalPage=Math.ceil(VIEW.length/PAGE_SIZE);
  if(PAGE<totalPage){
    PAGE++;
    renderTable();
  }
}

function prevPage(){
  if(PAGE>1){
    PAGE--;
    renderTable();
  }
}

function applyFilter(){

  const q=document.getElementById("search").value.trim().toLowerCase();
  const tgl=document.getElementById("filterTanggal").value;

  VIEW=DATA.filter(r=>{

    const cocokUnit = !q || String(r["NO UNIT"]).toLowerCase().includes(q);

    const cocokTanggal = !tgl || (
      new Date(r["TANGGAL"]).toISOString().slice(0,10) === tgl
    );

    return cocokUnit && cocokTanggal;
  });

  PAGE=1;
  renderTable();
}

function resetFilter(){
  document.getElementById("search").value="";
  document.getElementById("filterTanggal").value="";
  VIEW=DATA;
  PAGE=1;
  renderTable();
}

function formatTanggal(val){
  if(!val) return "";
  const d=new Date(val);
  if(isNaN(d)) return val;
  return d.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});
}

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("hidden");
}

function logout(){
  sessionStorage.clear();
  location.href="index.html";
}

function exportExcel(){

  if(!VIEW.length){
    alert("Tidak ada data untuk diexport");
    return;
  }

  const dataExport = VIEW.map(r=>({
    Tanggal: formatTanggal(r["TANGGAL"]),
    Unit: r["NO UNIT"] || "",
    "Meter Lalu": r._meterLalu==="-"? "" : r._meterLalu,
    "Meter Ini": isNaN(Number(r["ANGKA METER"])) ? "" : Number(r["ANGKA METER"]),
    Pemakaian: r._pakai==="-"? "" : r._pakai,
    Foto: r["FOTO_URL"] || ""
  }));

  const ws = XLSX.utils.json_to_sheet(dataExport);

  ws["!cols"] = [
    { wch: 15 }, // Tanggal
    { wch: 10 }, // Unit
    { wch: 12 }, // Meter Lalu
    { wch: 12 }, // Meter Ini
    { wch: 12 }, // Pemakaian
    { wch: 30 }  // Foto
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data PDAM");

  XLSX.writeFile(wb, "Data_PDAM.xlsx");
}

load();

</script>
</body>
</html>
