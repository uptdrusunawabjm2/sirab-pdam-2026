<!-- ADMIN FINAL -->
<script>
const API="https://script.google.com/macros/s/AKfycbwmkZnu2zx-Snz-pnxeIXUQDgwqVE-6aMBLYLbQv6i5N5y7bC5SajqSjHPzt8UJUqbZ8a/exec";
const TOKEN=sessionStorage.token;
const ROLE=sessionStorage.role;

if(!TOKEN||ROLE!=="admin") location.href="index.html";

function esc(s){return String(s||"").replace(/[&<>"]/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[a]));}

async function fetchTimeout(url,ms=15000){
 const ctrl=new AbortController();
 const id=setTimeout(()=>ctrl.abort(),ms);
 try{const r=await fetch(url,{signal:ctrl.signal});clearTimeout(id);return r;}
 catch(e){clearTimeout(id);throw e;}
}

async function load(){
 tb.innerHTML="<tr><td colspan=5>Loading...</td></tr>";
 try{
  const r=await fetchTimeout(API+"?mode=input&token="+TOKEN);
  const d=await r.json();

  if(!Array.isArray(d)){location.href="index.html";return;}

  tb.innerHTML=d.map(x=>`
   <tr>
    <td>${esc(x["TANGGAL INPUT"])}</td>
    <td><b>${esc(x["NO UNIT"])}</b></td>
    <td>${esc(x["METER BULAN LALU"])}</td>
    <td>${esc(x["METER BULAN INI"])}</td>
    <td>${x["FOTO_URL"]?`<a href="${esc(x["FOTO_URL"])}" target="_blank" rel="noopener">Lihat</a>`:""}</td>
   </tr>
  `).join("")||"<tr><td colspan=5>Tidak ada data</td></tr>";

 }catch(e){
  tb.innerHTML="<tr><td colspan=5>Gagal memuat data</td></tr>";
 }
}
load();
</script>
