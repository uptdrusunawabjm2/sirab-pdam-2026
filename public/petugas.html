<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Input Petugas</title>
<style>
*{box-sizing:border-box}
body{
margin:0;font-family:Segoe UI;
background:#0f172a;color:white
}
header{
padding:16px;text-align:center;
background:#020617;font-weight:700
}
.card{
background:#020617;border-radius:22px;
padding:20px;margin:16px;
box-shadow:0 10px 30px rgba(0,0,0,.4)
}
label{font-size:13px;color:#94a3b8}
input{
width:100%;padding:14px;margin:6px 0 14px;
border-radius:14px;border:1px solid #1e293b;
background:#020617;color:white;font-size:16px
}
button{
width:100%;padding:16px;border:none;border-radius:18px;
background:linear-gradient(135deg,#38bdf8,#0ea5e9);
font-weight:800;font-size:17px
}
.ok{color:#22c55e}.err{color:#ef4444}
#info{text-align:center;margin-top:12px;font-size:15px}
.preview{margin-top:10px;text-align:center}
.preview img{max-width:100%;border-radius:14px;border:1px solid #1e293b}
</style>
</head>
<body>

<header>INPUT METER AIR</header>

<div class="card">
<label>No Unit</label>
<input id="unit" placeholder="GM-A1.01 / TK-102">

<label>Meter Bulan Lalu</label>
<input id="lalu" type="number" inputmode="numeric">

<label>Meter Bulan Ini</label>
<input id="ini" type="number" inputmode="numeric">

<label>Foto Meter</label>
<input id="foto" type="file" accept="image/*" capture="environment">

<div class="preview" id="prev"></div>

<button onclick="kirim()">SIMPAN DATA</button>
<div id="info"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbx-RUXa9NRf5GPRjouhdBwGSDJD9Gv8Am-TeqbV2D0gFBwSuNzlTx4blySQJFRM00tF/exec";
const TOKEN=sessionStorage.token;
if(!TOKEN){location.href="index.html";}

foto.onchange=()=>{
 if(foto.files[0]){
  prev.innerHTML=`<img src="${URL.createObjectURL(foto.files[0])}">`;
 }
}

function rusun(u){return u.toUpperCase().startsWith("GM")?"GM":"TK";}

async function kirim(){
 if(!foto.files[0]){info.innerHTML="<span class='err'>Foto wajib</span>";return;}

 info.innerHTML="Mengupload...";

 const d=new Date(), t=d.toISOString().slice(0,10);
 const name=`${t}_${unit.value}.jpg`;

 const reader=new FileReader();
 reader.onload=async ()=>{
  const base64=reader.result.split(",")[1];

  let up=await fetch(API,{method:"POST",body:JSON.stringify({
   action:"upload",filename:name,base64:base64,type:"image/jpeg",rusun:rusun(unit.value)
  })}).then(r=>r.json());

  if(!up.status){info.innerHTML="<span class='err'>Upload gagal</span>";return;}

  let r=await fetch(API,{method:"POST",body:JSON.stringify({
   mode:"input",token:TOKEN,
   values:[new Date(),unit.value,lalu.value,ini.value,"","",up.url]
  })}).then(r=>r.json());

  info.innerHTML=r.status?"<span class='ok'>✔ Data tersimpan</span>":"<span class='err'>✖ Gagal</span>";
  if(r.status){unit.value="";lalu.value="";ini.value="";foto.value="";prev.innerHTML="";}
 };
 reader.readAsDataURL(foto.files[0]);
}
</script>
</body>
</html>
