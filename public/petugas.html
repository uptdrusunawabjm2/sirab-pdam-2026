<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Input Meter PDAM</title>
<script src="https://cdn.tailwindcss.com"></script>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#020617">

</head>

<body class="bg-slate-950 text-white min-h-screen">

<!-- TOPBAR -->
<div class="bg-slate-900 border-b border-slate-800 p-3 text-center font-semibold">
Input Meter Air
</div>

<div class="max-w-md mx-auto p-4 space-y-4">

<!-- STATUS ONLINE -->
<div id="net" class="text-center text-xs"></div>

<!-- CARD -->
<div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-3">

<label class="text-sm text-slate-400">No Unit</label>
<input id="unit" onblur="ambilMeterLalu()" oninput="this.value=this.value.toUpperCase()" class="w-full p-2 rounded bg-slate-800 border border-slate-700">

<label class="text-sm text-slate-400">Meter Bulan Lalu</label>
<input id="lalu" type="number" readonly
class="w-full p-2 rounded bg-slate-800 border border-slate-700 opacity-70 cursor-not-allowed">

<label class="text-sm text-slate-400">Meter Bulan Ini</label>
<input id="ini" type="number" class="w-full p-2 rounded bg-slate-800 border border-slate-700">

<label class="text-sm text-slate-400">Foto Meter</label>

<!-- FILE PICKER + CAMERA -->
<div class="flex gap-2">
  <button type="button" onclick="openCamera()"
  class="flex-1 bg-blue-600 hover:bg-blue-700 rounded p-2 text-sm">
  ðŸ“· Kamera
  </button>

  <button type="button" onclick="openGallery()"
  class="flex-1 bg-slate-700 hover:bg-slate-600 rounded p-2 text-sm">
  ðŸ–¼ Galeri
  </button>
</div>

<input id="foto" type="file" accept="image/*" class="hidden">

<img id="preview" class="hidden rounded-lg border border-slate-700">

<button id="btn" onclick="kirim()"
class="w-full bg-cyan-500 hover:bg-cyan-600 rounded-lg p-2 font-semibold">
SIMPAN
</button>

</div>

<div class="text-center text-xs text-slate-500">
PDAM Mobile Field App
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwy8MDN7v6zH-5WbBIN3YVm0q0AchlT8y7zP7_H0nAkH3WhkeogXfzHoB_IZsHF3NSGug/exec";
const TOKEN=sessionStorage.token;
if(!TOKEN) location.href="index.html";

/* ===== STATUS INTERNET ===== */
function updateNet(){
net.innerHTML = navigator.onLine
? "<span class='text-green-400'>ONLINE</span>"
: "<span class='text-yellow-400'>OFFLINE (data disimpan)</span>";
}
window.addEventListener("online",()=>{updateNet();syncQueue();});
window.addEventListener("offline",updateNet);
updateNet();

/* ===== PREVIEW FOTO ===== */
foto.onchange = e=>{
const f=e.target.files[0];
if(!f) return;
const r=new FileReader();
r.onload=x=>{
preview.src=x.target.result;
preview.classList.remove("hidden");
};
r.readAsDataURL(f);
};

/* ===== SIMPAN QUEUE OFFLINE ===== */
function saveQueue(obj){
const q=JSON.parse(localStorage.getItem("queue")||"[]");
q.push(obj);
localStorage.setItem("queue",JSON.stringify(q));
}

/* ===== SYNC SAAT ONLINE ===== */
async function syncQueue(){
if(!navigator.onLine) return;
let q=JSON.parse(localStorage.getItem("queue")||"[]");
if(!q.length) return;

for(const item of q){
try{
await fetch(API,{method:"POST",body:item.fd1});
await fetch(API,{method:"POST",body:item.fd2});
}catch(e){return;}
}
localStorage.removeItem("queue");
alert("Data offline berhasil disinkronkan");
}

/* ===== FUNGSI UTAMA ===== */
async function kirim(){

if(!unit.value.trim()){ alert("No Unit wajib"); return; }
if(!lalu.value || !ini.value){ alert("Meter wajib"); return; }

const file=foto.files[0];
if(!file){ alert("Foto wajib"); return; }

btn.disabled=true;
btn.innerText="Memproses...";

/* KOMPRES FOTO */
const img=new Image();
const reader=new FileReader();

reader.onload=e=>img.src=e.target.result;

img.onload=async()=>{

const canvas=document.createElement("canvas");
const MAX=1280;
let w=img.width, h=img.height;
if(w>MAX){ h=Math.round(h*(MAX/w)); w=MAX; }
canvas.width=w; canvas.height=h;
canvas.getContext("2d").drawImage(img,0,0,w,h);

const base64=canvas.toDataURL("image/jpeg",0.6).split(",")[1];

/* NAMA FILE */
const d=new Date();
const tgl=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const namaFile=`${unit.value.trim()}_${tgl}_${Date.now()}.jpg`;

/* FORM UPLOAD */
const fd1=new FormData();
fd1.append("data",JSON.stringify({
action:"upload",
filename:namaFile,
base64:base64,
type:"image/jpeg"
}));

/* FORM DATA */
const fd2=new FormData();
fd2.append("data",JSON.stringify({
mode:"input",
token:TOKEN,
values:[new Date(),unit.value,lalu.value,ini.value,"","",""]
}));

/* ===== JIKA OFFLINE ===== */
if(!navigator.onLine){
saveQueue({fd1:fd1,fd2:fd2});
alert("Disimpan offline. Akan sync saat online.");
resetForm();
return;
}

/* ===== ONLINE ===== */
try{
const up=await fetch(API,{method:"POST",body:fd1}).then(r=>r.json());
fd2.set("data",JSON.stringify({
mode:"input",
token:TOKEN,
values:[new Date(),unit.value,lalu.value,ini.value,"","",up.url]
}));
await fetch(API,{method:"POST",body:fd2});
alert("Data tersimpan");
}catch(e){
saveQueue({fd1:fd1,fd2:fd2});
alert("Gagal kirim. Disimpan offline.");
}

resetForm();
};

reader.readAsDataURL(file);
}

function resetForm(){
unit.value="";
lalu.value="";
ini.value="";
foto.value="";
preview.classList.add("hidden");
btn.disabled=false;
btn.innerText="SIMPAN";
}

/* ===== REGISTER SERVICE WORKER ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}

/* ===== PWA INSTALL BUTTON ===== */
let deferredPrompt;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const btnInstall = document.createElement("button");
  btnInstall.innerText = "Install App";
  btnInstall.className =
    "fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-600 px-4 py-2 rounded-lg shadow-lg";
  document.body.appendChild(btnInstall);

  btnInstall.onclick = async () => {
    btnInstall.remove();
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  };
});

/* ===== PILIH SUMBER FOTO ===== */
function openCamera(){
  foto.setAttribute("capture","environment");
  foto.click();
}

function openGallery(){
  foto.removeAttribute("capture");
  foto.click();
}

/* ===== AMBIL METER BULAN LALU OTOMATIS ===== */
async function ambilMeterLalu(){
  const u = unit.value.trim().toUpperCase();
  if(!u) return;

  try{
    const r = await fetch(API + "?mode=lastmeter&unit=" + encodeURIComponent(u));
    const j = await r.json();
    if(j && j.status){
      lalu.value = j.meter || 0;
    }
  }catch(e){
    console.log("Gagal ambil meter lalu");
  }
}

</script>

</body>
</html>
