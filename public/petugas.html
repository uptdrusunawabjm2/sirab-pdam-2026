<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Petugas</title>
<style>
body{margin:0;font-family:Segoe UI;background:#0f172a;color:white}
.card{background:#020617;border:1px solid #1e293b;border-radius:16px;padding:22px;max-width:420px;margin:8vh auto}
input,button{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:none}
button{background:#38bdf8;font-weight:700}
.ok{color:#22c55e}.err{color:#ef4444}
</style>
</head>
<body>

<div class="card">
<h2>INPUT METER + FOTO</h2>
<input id="unit" placeholder="GM-A1.01 / TK-102">
<input id="lalu" type="number" placeholder="Meter lalu">
<input id="ini" type="number" placeholder="Meter sekarang">
<input id="foto" type="file" accept="image/*" capture="environment">
<button onclick="kirim()">SIMPAN</button>
<div id="info"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbx-RUXa9NRf5GPRjouhdBwGSDJD9Gv8Am-TeqbV2D0gFBwSuNzlTx4blySQJFRM00tF/exec";
const TOKEN=sessionStorage.token;

if(!TOKEN){location.href="index.html";}

function rusun(u){return u.toUpperCase().startsWith("GM")?"GM":"TK";}

async function kirim(){
 if(!foto.files[0]){info.innerHTML="<span class='err'>Foto wajib</span>";return;}

 const d=new Date(), t=d.toISOString().slice(0,10);
 const name=`${t}_${unit.value}.jpg`;

 const reader=new FileReader();
 reader.onload=async ()=>{
   const base64=reader.result.split(",")[1];

   let up=await fetch(API,{method:"POST",body:JSON.stringify({
     action:"upload", filename:name, base64:base64, type:"image/jpeg", rusun:rusun(unit.value)
   })}).then(r=>r.json());

   if(!up.status){info.innerHTML="<span class='err'>Upload gagal</span>";return;}

   let r=await fetch(API,{method:"POST",body:JSON.stringify({
     mode:"input", token:TOKEN,
     values:[new Date(),unit.value,lalu.value,ini.value,"","",up.url]
   })}).then(r=>r.json());

   info.innerHTML=r.status?"<span class='ok'>✔ Tersimpan</span>":"<span class='err'>✖ Gagal</span>";
 };
 reader.readAsDataURL(foto.files[0]);
}
</script>
</body>
</html>
